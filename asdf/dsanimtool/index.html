<!DOCTYPE html>
<html dir="ltr">

<head>
    <meta charset="utf-8">
    <link rel="icon"
        href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAzZv/9M2b//jNm//42aP/+OGr//jdp//4zZv/+M2b//jFl//4zZv//M2b//zNm//8zZv//M2b//zNm//8zZv//M2b//jJl//9GdP//sMT//8XU//+Kp///M2b//zJl//87a///M2b//zNm//8zZv//M2b//zNm//8zZv//M2b//zNm//4xZf//T3v//+nv////////lrD//y9j//84af//M2b//zNm//8zZv//M2b//zNm//8zZv//M2b//zNm//8zZv/+MWX//097///q7////v///3ia//8zZv//M2b//zNm//8zZv//M2b//zNm//8zZv//Mmb//zNm//8zZv//M2b//jFl//9Pe/////////f5//9hif//M2b//zNm//8zZv//M2b//zNm//8zZv//MWX//zNm//8zZv//M2b//jNm//4xZf//T3v////////s8f//bY///zNm//8zZv//M2b//zNm//88bf//MWX//zNm//8zZv//M2b//zNm//4zZv/+MWX//097/////////////zNm//8zZv//M2b//zNm//9BcP//MWX//zNm//8zZv//M2b//zNm//8zZv/+M2b//jFl//9Pe////////////////////////////////////////6y3//+st///M2b//zNm//8zZv//M2b//jNm//4xZf//UHz//////////////////////////////////////////////////6y3//8zZv//M2b//zNm//4zZv/+MWX//1B8/////////////6y3//8zZv//M2b//8bS//+st///////////////////M2b//zNm//8zZv/+M2b//jFl//9QfP//8/b/////////////M2b//zNm//8zZv//M2b//zNm/////////////zNm//8zZv//M2b//jNm//4xZf//UHz//+zx////////vsb//zNm//8zZv//M2b//zNm//8zZv////////////8zZv//M2b//zNm//4zZv/+MWX//1B8///r8P////////////+5yv//M2b//zNm//8zZv//M2b///////8zZv//M2b//zNm//8zZv/+M2b//jFl//9QfP//6/D///7////y9P//s8D//zNm//8zZv//M2b/////////////M2b//zNm//8zZv//M2b//zNm//4xZf//UHv//+Xr////////////////////////////////////////z9T//zNm//8zZv//M2b//zNm//4zZv/9M2b//zNm//8zZv//M2b//6y3//8zZv//Omv//l2D//5hhf/+c5b//jNm//8zZv//OGr//jNm//4zZv/+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==">
    <title>饥荒动画播放器</title>
    <style>
        :root {
            --size: 1.5vw;
            --a-color: red;
            --a-hover-color: white;
            --a-hover-background-color: red;
            --a-active-color: blue;
            --large-size: 2em;
            font-size: var(--size);
            --basefont: Monaco, "Comic Sans Ms", "方正稚艺简体", "华文细黑", "Microsoft Yahei", "微软雅黑", "宋体", Arial, Helvetica, sans-serif;
        }

        * {
            font-family: var(--basefont);
        }

        .fontface1 {
            font-family: 华文宋体, 宋体, Simsun, Simhei, 黑体, "system-ui", -apple-system, BlinkMacSystemFont, segoe ui, Roboto, Helvetica, Arial, sans-serif, apple color emoji, segoe ui emoji, segoe ui symbol;
        }

        input {
            --placeholder-color: rgb(255, 123, 123);
            outline: 0;
            appearance: none;
            font-size: 1em;
        }

        input:hover {
            background-color: #fff4d4;
        }

        input:focus {
            background-color: #ffdb7a;
        }

        input[type="button"]:hover {
            appearance: none;
        }

        input::-webkit-input-placeholder {
            /* Chrome/Opera/Safari */
            color: var(--placeholder-color);
        }

        input::-moz-placeholder {
            /* Firefox 19+ */
            color: var(--placeholder-color);
        }

        input:-ms-input-placeholder {
            /* IE 10+ */
            color: var(--placeholder-color);
        }

        input:-moz-placeholder {
            /* Firefox 18- */
            color: var(--placeholder-color);
        }

        a {
            color: var(--a-color);
            cursor: pointer;
            text-decoration: none;
            outline: none;
        }

        a:hover {
            color: var(--a-hover-color);
            background-color: var(--a-background-color);
        }

        a:active {
            color: var(--a-active-color);
            background-color: var(--a-background-color);
        }

        .transition {
            transition: all 0.3s cubic-bezier(.17, .84, .44, 1);
            transition-property: var(--trans);
            transition-timing-function: var(--timing);
            transition-delay: var(--delay);
        }

        .d3 {
            perspective: var(--view);
            transform-style: preserve-3d;
        }

        .large {
            font-size: var(--large-size);
        }

        .flex {
            display: flex;
        }

        .flex-item {
            flex: auto;
        }

        .flex-vertical {
            display: flex;
            flex-direction: column;
        }

        .center {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: row;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
            /* Chrome Safari */
        }

        .hide-scrollbar {
            scrollbar-width: none;
            /* firefox */
            -ms-overflow-style: none;
            /* IE 10+ */
            overflow-x: hidden;
            overflow-y: auto;
        }

        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .glass {
            backdrop-filter: blur(var(--blur));
        }

        .bgc {
            background-color: var(--bgc);
        }

        .gray {
            filter: grayscale(1);
        }

        .sticky {
            filter: var(--filter) url(#filter-sticky);
        }

        .stick {
            position: sticky;
        }

        ::selection {
            background-color: rgba(0, 0, 0, 0.651);
            color: rgba(255, 255, 255, 0.925);
        }

        /*自动贴靠边缘*/
        .snapy {
            scroll-snap-type: y mandatory;
        }

        .snapx {
            scroll-snap-type: x mandatory;
        }

        .snap {
            scroll-snap-align: start;
        }

        #panel {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 20%;
            z-index: 5000;
        }

        .drop-area,
        .drop-area2 {
            border: 2px dashed #ccc;
            width: 200px;
            height: 100%;
            line-height: 50px;
            text-align: center;
            cursor: pointer;
            display: inline-block;
            background-color: #ffebcd5e;
            box-sizing: border-box;
        }

        #displayDiv {
            position: fixed;
            right: 0;
            bottom: 0;
            padding: 10px;
            background-color: rgba(0, 0, 0, .7);
            color: white;
        }

        .drop-area2 {
            display: none;
        }

        .drop-area:hover {
            background-color: #bee1ffaa;
        }

        .image-container {
            position: relative;
            margin-top: 50%;
            margin-left: 30%;
        }

        .image-container img {
            position: absolute;
            top: 0;
            left: 0;
        }

        body {
            min-height: 2000px;
        }

        select {
            padding-left: 8px;
            border-radius: 1px;
            border: none;
            background-color: #f2f2f298;
            font-size: 16px;
            min-width: 2em;
            width: 30%;
        }

        /* 鼠标悬停时的样式 */
        select:hover {
            background-color: #e6e6e69a;
        }

        /* 下拉箭头图标样式 */
        select::after {
            content: '\25BC';
            position: absolute;
            right: 0;
            top: auto;
            bottom: auto;
            margin-right: .5em;
        }

        /* 禁用状态下的样式 */
        select[disabled] {
            opacity: .7
        }

        .progress-bar {
            width: calc(100% - 20px);
            height: 20px;
            position: relative;
            --slider1: #9280faa8;
            --slider2: #e4a6a69d;
            background-color: var(--slider2);
        }

        .slider {
            width: 20px;
            height: 20px;
            background-color: rgba(235, 139, 122, 0.836);
            position: relative;
        }

        #info {
            position: fixed;
            right: 0;
            top: 0;
            line-height: 1em;
            --a-hover-color: #e87777;
            background: #00000059;
            color: white;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        #info p {
            margin: 0.1em;
        }

        #topflex {
            height: 4em;
        }

        #topflex,
        pre {
            margin: 0;
            background: #f0f8ff78;
            position: relative;
        }

        h1 {
            margin: 0;
            padding: 0;
        }

        .title:hover {
            color: rgba(98, 98, 255, 0.719);
        }

        #dropareas {
            width: 100%;
        }

        .buttons {
            width: 10%;
            display: inline-block;
            border: none;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            color: #000000;
            background-color: #d3d3d393;
            overflow: visible;
        }

        .buttons:hover,
        button:hover {
            filter: brightness(0.9);
        }

        .buttons:active,
        button:active {
            filter: brightness(0.8);
        }

        .paper-border {
            --primary: #030303e5;
            color: var(--primary);
            border-color: var(--primary);
            border-style: solid;
            border-bottom-left-radius: 398px 7px;
            border-bottom-right-radius: 61px 13px;
            border-top-left-radius: 165px 15px;
            border-top-right-radius: 15px 195px;
            border-width: 2px;
            box-shadow: 0px 2px 1px rgba(0, 0, 0, 0.281);
            box-sizing: border-box;
        }

        /*.paper-border:hover {
            border-bottom-left-radius: 46px 294px;
            border-bottom-right-radius: 171px 33px;
            border-top-left-radius: 25px 144px;
            border-top-right-radius: 240px 65px;
            border-width: 2px;
        }*/

        input {
            border: 2px rgba(124, 124, 124, 0.637) dashed;
        }

        .clone-container {
            opacity: 0.5;
            filter: url(#colorMeMatrixRed);
        }

        #tools {
            position: absolute;
            display: grid;
            align-content: left;
            align-self: left;
            left: 0;
            top: 0;
            height: 100%;
        }

        #tools div {
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
        }

        #tools>div {
            height: 50%;
        }

        #tools button {
            height: 100%;
            position: relative;
            width: auto;
            background: #a29d9d87;
            border: none;
        }

        .animimage {
            box-sizing: border-box;
        }

        .animimage:hover {
            box-shadow: 0px 0px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .clonedanimimage {
            user-drag: none;
            -webkit-user-drag: none;
            /* 兼容性前缀 */
        }

        #dropareaswrapper {
            position: relative;
            width: 20%;
        }

        #dropareaswrapper>div {
            height: 100%
        }

        .float {
            display: none;
            position: relative;
            width: 0;
            height: 0;
            left: 0;
            top: 0;
        }

        .float.show-floater {
            display: block;
        }

        .floatermenu {
            width: 20vw;
            position: relative;
            box-shadow: 2px 8px 8px -5px rgba(0, 0, 0, 0.3);
            opacity: 0;
        }

        .float.show-floater .floatermenu {
            opacity: 1;
        }

        .item {
            width: 100%;
            height: auto;
            background-color: #8686865b;
        }

        .item:hover {
            background-color: #77777780;
        }

        .item:active {
            filter: brightness(0.8);
        }

        .paper-switch input,
        .paper-switch-2 input {
            height: 0;
            opacity: 0;
            width: 0;
        }

        .paper-switch-1 input {
            height: 0;
            opacity: 0;
            width: 0;
            --primary: #e87777e5;
            color: #41403e;
            color: var(--primary);
            border-color: var(--primary);
            background: transparent;
            border-bottom-left-radius: 43px 307px;
            border-bottom-right-radius: 211px 43px;
            border-style: solid;
            border-top-left-radius: 255px 15px;
            border-top-right-radius: 15px 225px;
            border-width: 2px;
            display: block;
            font-size: 1rem;
            outline: none;
            padding: 0.5rem;
        }

        .paper-switch-2 input {
            --primary: #e87777e5;
            color: #41403e;
            color: var(--primary);
            border-color: var(--primary);
            background: transparent;
            border-bottom-left-radius: 43px 307px;
            border-bottom-right-radius: 211px 43px;
            border-style: solid;
            border-top-left-radius: 255px 15px;
            border-top-right-radius: 15px 225px;
            border-width: 2px;
            display: block;
            font-size: 1rem;
            outline: none;
            padding: 0.5rem;
        }

        .paper-switch-2 .paper-switch-slider::before {
            bottom: 3px;
            height: 18px;
            width: 17px;
        }

        .paper-switch-1 .paper-switch-slider::before {
            bottom: 3px;
            height: 18px;
            width: 17px;
        }

        .paper-switch .paper-switch-slider::before,
        .paper-switch-2 .paper-switch-slider::before {
            background: var(--secondary);
            border-bottom-left-radius: 15px 255px;
            border-bottom-right-radius: 225px 15px;
            border-top-left-radius: 255px 15px;
            border-top-right-radius: 15px 225px;
            content: "";
            left: 4px;
            position: absolute;
            transition: 0.4s;
        }

        .paper-switch-1 .paper-switch-slider::before {
            background: var(--secondary);
            border-bottom-left-radius: 15px 255px;
            border-bottom-right-radius: 225px 15px;
            border-top-left-radius: 255px 15px;
            border-top-right-radius: 15px 225px;
            content: "";
            left: 4px;
            position: absolute;
            transition: 0.4s;
        }

        .paper-switch .paper-switch-slider,
        .paper-switch-2 .paper-switch-slider {
            --secondary: rgba(245, 120, 120, 0.904);
            --primary: rgba(6, 7, 7, 0.925);
            background-color: #6cb6f388;
            border-color: var(--primary);
            border-bottom-left-radius: 15px 255px;
            border-bottom-right-radius: 225px 15px;
            border-style: solid;
            border-top-left-radius: 255px 15px;
            border-top-right-radius: 15px 225px;
            border-width: 2px;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: 0.4s;
        }

        .paper-switch-1 .paper-switch-slider {
            --secondary: rgba(245, 120, 120, 0.904);
            --primary: rgba(6, 7, 7, 0.925);
            background-color: #f2f9ffaf;
            border-color: var(--primary);
            border-bottom-left-radius: 15px 255px;
            border-bottom-right-radius: 225px 15px;
            border-style: solid;
            border-top-left-radius: 255px 15px;
            border-top-right-radius: 15px 225px;
            border-width: 2px;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: 0.4s;
        }

        .paper-switch input:checked+.paper-switch-slider::before,
        .paper-switch-2 input:checked+.paper-switch-slider::before {
            transform: translateX(24px);
        }

        .paper-switch-1 input:checked+.paper-switch-slider::before {
            --secondary: rgba(120, 245, 130, 0.904);
        }

        label.paper-switch-2 {
            position: relative;
            display: inline-block;
            width: 51px;
        }

        label.paper-switch-2-label {
            margin-right: 2px;
        }

        label.paper-switch-1 {
            position: relative;
            display: inline-block;
            width: 30;
        }

        label.paper-switch-1-label {
            margin-right: 2px;
        }

        .menus {
            --lh: 3vw;
            height: var(--lh);
        }

        .menus>div {
            height: 100%;
        }

        .menus div {
            line-height: var(--lh);
        }
    </style>
</head>

<body>
    <div id="panel">
        <div id="topflex" class="center">
            <h1 class="title no-select transition" onclick="document.getElementById('detail').style.display='block';">
                动画播放器</h1>
            <div id="tools">
                <div>
                    <label for="paperSwitch1" class="paper-switch-2-label no-select">
                        洋葱皮
                    </label>
                    <label class="paper-switch-2">
                        <input id="paperSwitch1" name="paperSwitch1" type="checkbox" onclick="ChangeOnion();">
                        <span class="paper-switch-slider"></span>
                    </label>
                </div>
                <div>
                    <label for="paperSwitch2" class="paper-switch-2-label no-select">
                        English
                    </label>
                    <label class="paper-switch-2">
                        <input id="paperSwitch2" name="paperSwitch2" type="checkbox" onclick="ChangeLanguage();">
                        <span class="paper-switch-slider"></span>
                    </label>
                </div>
                <div>
                    <label for="paperSwitch3" class="paper-switch-1-label no-select">
                        服务器
                    </label>
                    <label class="paper-switch-1">
                        <input id="paperSwitch3" name="paperSwitch3" type="checkbox" onclick="UpdateServerState();">
                        <span class="paper-switch-slider"></span>
                    </label>
                </div>
            </div>
        </div>
        <div id="detail" style="display: none;">
            <pre>
打开build.json和anim.json以播放动画
默认该html文件与图片所在目录相同，如果不同需要手动输入file:///图片路径，比如file:///C:/Users/x/Desktop/anim/
滚轮改变图片frame
鼠标拖动图片
参数：图片红点坐标(x,y)，放缩(sx,sy)，平移(tx,ty)，旋转an，图层顺序z-index（越大越靠前，真实值为50-zindex）
            </pre>
        </div>
        <div id="info">
            <p><a href="https://github.com/ZzzzzzzSkyward/DSTmodutils" target="_blank">github repo1</a></p>
            <p><a href="https://github.com/Jerry457/ds_tool" target="_blank">github repo2</a></p>
            <p class="no-select">作者zzzzzzzs</p>
        </div>
        <div class="flex menus" style="z-index:5;position:relative;">
            <div name="wrapper" id="dropareaswrapper" class="flex-vertical">
                <div id="dropareas" class="flex">
                    <div id="drop-area" class="drop-area no-select">anim.json/build.json</div>
                    <div id="dropZone" class="drop-area2">
                        拖入图片文件夹
                    </div>
                </div>
                <div class="float transition no-select" id="dropareasfloater">
                    <div class="floatermenu flex-vertical transition">
                        <div class="item transition paper-border" onclick="SaveFiles()">保存build.json</div>
                        <div class="item transition paper-border" onclick="LoadRootFiles()">自动加载根目录文件</div>
                        <div class="item transition paper-border" onclick="RenderToCanvas()">截图</div>
                    </div>
                </div>
            </div>
            <input id="imagepath" placeholder="file:\\\c:"></input>

            <select id="list1">
                <option value="" selected>bank</option>
            </select>

            <select id="list2">
                <option value="" selected>anim</option>
            </select>

            <button id="playPauseButton" class="transition buttons paper-border">播放</button>
            <button id="NextFrameButton" class="transition buttons paper-border">下一帧</button>
            <button id="PrevFramePauseButton" class="transition buttons paper-border">上一帧</button>
            <div id="valueContainer" style="align-self: center;min-width: 2em;text-align: center;">0</div>
        </div>
        <div class="progress-bar transition">
            <div id="slider" class="slider">
            </div>
        </div>
        <div id="displayDiv" style="display: none;z-index:1001;"></div>
        <svg>
            <filter id="colorMeMatrixRed">
                <feColorMatrix in="SourceGraphic" type="matrix" values="1 1 1 1 0
				              0 0 0 0 0
				              0 0 0 0 0
				              0 0 0 1 0" />
            </filter>
        </svg>
    </div>
    <div id="image-container-clone" class="image-container clone-container"></div>
    <div id="image-container" class="image-container"></div>
    <script>
        let strings = {
            play: "播放",
            language: "Chinese",
            pause: "暂停",
            serverstate: "服务器",
            nextframe: "下一帧",
            prevframe: "上一帧",
            save: "保存build.json",
            dropjson: "anim/build json",
            load: "自动加载根目录文件",
            selectedBA: "已选bank/anim",
            selectedFolder: "已选文件夹",
            onion: '洋葱皮',
            title: '动画播放器',
            detail: `打开build.json和anim.json以播放动画
默认该html文件与图片所在目录相同，如果不同需要手动输入file:///图片路径，比如file:///C:/Users/x/Desktop/anim/
滚轮改变图片frame
鼠标拖动图片
参数：图片红点坐标(x,y)，放缩(sx,sy)，平移(tx,ty)，旋转an，图层顺序z-index（越大越靠前，真实值为50-zindex）
`
        };
        let strings_zh = strings;
        let strings_en = {
            play: "Play",
            pause: "Pause",
            language: "英语",
            serverstate: "Server",
            nextframe: "Next",
            prevframe: "Prev",
            save: "Save build.json",
            load: "Load Root Files",
            selectedBA: "Selected bank/anim",
            dropjson: "anim/build json",
            selectedFolder: "Selected Folder",
            onion: 'Onion Skin',
            title: 'Animation Player',
            detail: `Open build.json and anim.json to play animation
The default html file is the same as the image directory. If it is different, you need to manually enter file:///image path, such as file:///C:/Users/x/Desktop/anim/
Mouse wheel to change image frame
Drag the image with the mouse
Parameters: image pivot (x, y), zoom (sx, sy), translation (tx, ty), rotation (an), layer order (z-index) (the larger the value, the closer to the front, the real value is 50-zindex)
`
        };
        let language = "zh";
        let bank = "";
        let onionskin = false;
        let anim = "";
        let animdata;
        let build_data;
        let currenttask;
        let imagepath = "";
        let playing = false;
        let currentframe = 0;
        let totalframes = 0;
        let requestframe;
        let fromprogressbar;
        let progress = 0;
        let server_url = "http://localhost:5005"
        const dropZone = document.getElementById('dropZone');
        const playPauseButton = document.getElementById('playPauseButton');
        const NextFrameButton = document.getElementById('NextFrameButton');
        const PrevFramePauseButton = document.getElementById('PrevFramePauseButton');
        const imageContainer = document.getElementById('image-container');
        const displayDiv = document.getElementById('displayDiv');
        let trackingelement = null;
        let hoverelement = null;

        const progressBar = document.querySelector('.progress-bar');
        const slider = document.getElementById('slider');
        const imagePathInput = document.querySelector('#imagepath');
        const dropAreasWrapper = document.querySelector('#dropareaswrapper');
        const dropAreaFloater = document.querySelector('#dropareasfloater');
        const onionInput = document.querySelector('#paperSwitch1');
        function ChangeOnion() {
            onionskin = onionInput.checked;
        }
        function OnOnionChange() {
            onionInput.checked = onionskin;
        }
        ChangeOnion();
        function ChangeLanguage() {
            const languageInput = document.querySelector('#paperSwitch2');
            language = languageInput.checked ? "en" : "zh";
            strings = language == "en" ? strings_en : strings_zh;
            document.getElementById("NextFrameButton").innerHTML = strings.nextframe;
            document.getElementById("PrevFramePauseButton").innerHTML = strings.prevframe;
            document.getElementById("dropareasfloater").firstElementChild.children[0].innerHTML = strings.save;
            document.getElementById("dropareasfloater").firstElementChild.children[1].innerHTML = strings.load;
            document.getElementById("drop-area").innerHTML = strings.dropjson;
            document.getElementById("dropZone").innerHTML = strings.selectedFolder;
            document.getElementById("playPauseButton").innerHTML = strings.play;
            document.getElementsByClassName("paper-switch-2-label")[0].innerHTML = strings.onion;
            document.getElementsByClassName("paper-switch-2-label")[1].innerHTML = strings.language;
            document.getElementsByClassName("paper-switch-1-label")[0].innerHTML = strings.serverstate;
            document.getElementsByClassName("title")[0].innerHTML = strings.title;
            document.getElementById("detail").firstElementChild.innerHTML = strings.detail;
        }
        ChangeLanguage();
        dropAreasWrapper.addEventListener('mouseenter', showFloat);
        dropAreasWrapper.addEventListener('mouseleave', hideFloat);
        function showFloat() {
            dropAreaFloater.classList.add("show-floater");
        }

        function hideFloat() {
            dropAreaFloater.classList.remove("show-floater");
        }
        function SaveFiles() {
            if (!build_data) return;
            let json = JSON.stringify({ Symbol: build_data });

            let blob = new Blob([json], { type: "application/json" });

            let url = URL.createObjectURL(blob);

            let a = document.createElement('a');
            a.href = url;
            a.download = 'build.json';

            a.click();

            URL.revokeObjectURL(url);

        }
        async function LoadRootFiles() {

            // 获取文件路径
            const animPath = imagepath + 'anim.json';
            const buildPath = imagepath + 'build.json';
            const ABPath = imagepath + 'animbuild.json';

            // 同时加载两个文件
            try {
                const animRes = await
                    fetch(animPath);

                // 解析JSON
                const animData = await animRes.json();
                RenderAnim(animData.banks);
            } catch (e) { }
            try {
                const buildRes = await
                    fetch(buildPath);

                // 解析JSON
                const buildData = await buildRes.json();
                RenderImage(buildData.Symbol);
            } catch (e) { }
            try {
                const ABRes = await fetch(abPath);
                const ABData = await ABRes.json();
                RenderAnim(ABData.banks);
                RenderImage(ABData.Symbol);
            } catch (e) { }
        }
        // 监听输入框的 change 事件
        imagePathInput.addEventListener('change', function (event) {
            imagepath = event.target.value; // 获取输入框的值并存储在变量中
        });
        imagepath = imagePathInput.value;
        // 鼠标按下时开始监听鼠标移动事件
        slider.addEventListener('mousedown', function (event) {
            event.preventDefault();
            slider.classList.add('transition');
            // 获取初始位置
            const startX = event.clientX;
            const oldprogress = progress;

            // 监听鼠标移动事件，更新进度条和全局变量
            function moveSlider(event) {
                const dx = event.clientX - startX;
                let newProgress = Math.max(0, Math.min(oldprogress + (dx / progressBar.offsetWidth), 1));
                //console.log(event.clientX, startX, dx, progressBar.offsetWidth, newProgress, progress);
                fromprogressbar = true;
                updateProgressBar(newProgress);
                progress = newProgress;
                OnProgressChange();
            }

            // 鼠标松开时停止监听鼠标移动事件
            function stopMove() {
                document.removeEventListener('mousemove', moveSlider);
                document.removeEventListener('mouseup', stopMove);
                slider.classList.remove('transition');
            }


            document.addEventListener('mousemove', moveSlider);
            document.addEventListener('mouseup', stopMove);
        });

        function OnProgressChange() {
            requestframe = progress * totalframes;
            requestframe = Math.round(requestframe);
        }

        // 更新进度条和滑块位置
        function updateProgressBar(value) {
            if (!value) return;
            slider.style.left = `${value * 100}%`;
            progressBar.style.background =
                `linear-gradient(to right, var(--slider1) ${value * 100}%, var(--slider2) ${value * 100}%)`;
        }
        // 点击进度条时更新滑块位置和全局变量
        progressBar.addEventListener('click', function (event) {
            const clickX = event.clientX - progressBar.getBoundingClientRect().left;
            const newProgress = Math.max(0, Math.min(clickX / progressBar.offsetWidth, 1));
            updateProgressBar(newProgress);
            fromprogressbar = true;
            progress = newProgress;
            OnProgressChange();
        });

        function AllowDrag(imgElement) {
            let isDragging = false;
            let startX, startY;

            let updatedrag = function (event) {
                if (isDragging) {
                    const newX = event.clientX - startX;
                    const newY = event.clientY - startY;

                    // 更新图片元素的 left 和 top 属性以改变其位置
                    imgElement.style.left = `${newX}px`;
                    imgElement.style.top = `${newY}px`;
                    //更新transform-origin
                    imgElement.style.transformOrigin = `${-newX}px ${-newY}px`;

                    // 可根据需要进行其他操作，例如限制范围等

                }
            }

            // 鼠标按下时开始拖动
            imgElement.addEventListener('mousedown', function (event) {
                event.preventDefault();

                // 获取初始位置和鼠标点击位置的偏移量
                startX = event.clientX - imgElement.offsetLeft;
                startY = event.clientY - imgElement.offsetTop;

                isDragging = true; // 开始拖动状态
                // 监听鼠标移动事件，在拖动状态下更新图片位置
                document.addEventListener('mousemove', updatedrag);
            });

            // 鼠标松开时停止拖动状态
            document.addEventListener('mouseup', function () {
                isDragging = false;
                document.removeEventListener('mousemove', updatedrag);
            });
        }
        // 监听鼠标滚轮事件
        imageContainer.addEventListener('wheel', function (event) {
            event.preventDefault(); // 阻止默认的页面滚动行为
            let imgElement = event.target;
            const zoomAmount = event.deltaY > 0 ? 1 : -1;
            let src = imgElement.src
            let number = src.match(/(\d+)\.png/)[1] - 0;
            number += zoomAmount;
            if (number < 0) number = 0;
            let newsrc = src.replace(/(\d+)\.png/, number + ".png");
            imgElement.src = newsrc;
        });
        function UpdateImageInfo(target) {
            if (!target) {
                displayDiv.style.display = 'none';
                return;
            }
            let src = target.src;
            const style = window.getComputedStyle(target);
            let mat = GetMatrix(target);
            // 计算 z-index、translateX、translateY、scaleX、scaleY 和 rotate 值
            const zIndex = style.zIndex;
            //const a,b,c,d,tx,ty=mat
            const a = mat[0];
            const b = mat[1];
            const c = mat[2];
            const d = mat[3];
            const tx = mat[4];
            const ty = mat[5];
            const scaleX = Math.sqrt(a ** 2 + b ** 2);
            const scaleY = Math.sqrt(c ** 2 + d ** 2);
            const rotate0 = Math.atan2(b,
                a) / Math.PI * 180;
            const rotate1 = Math.asin((b - c) / (2 * Math.sqrt(a ** 2 + c ** 2))) / Math.PI * 180;
            const rotate2 = Math.acos((a + d) / (2 * Math.sqrt(b ** 2 + d ** 2))) / Math.PI * 180;
            let rotate = rotate0 || rotate1 || rotate2 || 0;
            displayDiv.innerHTML =
                `${src}<br/>
                layer:${target.getAttribute("layername")}<br/>
                -x: ${target.style.left}<br/>
                -y: ${target.style.top}<br/>
                tx: ${tx.toFixed(2)}<br/>
                ty: ${ty.toFixed(2)}<br/>
                sx: ${scaleX.toFixed(2)}<br/>
                sy: ${scaleY.toFixed(2)}<br/>
                angle(approx): ${rotate.toFixed(2)}deg<br/>
                matrix: ${a.toFixed(2)},${b.toFixed(2)},${c.toFixed(2)},${d.toFixed(2)}<br/>
                50-zindex:${zIndex}`;
            displayDiv.style.display = 'block';
        }
        // 监听鼠标移入事件

        imageContainer.addEventListener('mouseover', function (event) {
            // 检查是否是 img 元素
            if (event.target.tagName === 'IMG') {
                const src = event.target.getAttribute('src');
                const target = event.target;
                hoverelement = target;
                UpdateImageInfo(target);
            }
        });
        imageContainer.addEventListener('click', function (event) {
            // 检查是否是 img 元素
            if (event.target.tagName === 'IMG') {
                const src = event.target.getAttribute('src');
                const target = event.target;
                const IsRightClick = event.button === 2;
                if (trackingelement && trackingelement == target && IsRightClick) {
                    trackingelement = null;
                } else {
                    trackingelement = target;
                }
                UpdateImageInfo(hoverelement || trackingelement);
            }
            else {
                trackingelement = null;
                UpdateImageInfo(hoverelement);
            }
        });

        // 监听鼠标移出事件
        imageContainer.addEventListener('mouseout', function () {
            hoverelement = null;
            UpdateImageInfo(trackingelement);
        });

        function updateframe(f) {
            currentframe = f;
            let ctn = document.getElementById('valueContainer');
            ctn.innerText = f;
        }

        function play() {
            playing = true;
            playPauseButton.textContent = strings.pause;
        }

        function pause() {
            playing = false;
            playPauseButton.textContent = strings.play;
        }

        playPauseButton.addEventListener('click', function () {
            if (playing) {
                pause();
            } else {
                play();
            }
        });

        function oneframe(f) {
            requestframe = currentframe + f;
        }
        NextFrameButton.addEventListener('click', function () {
            oneframe(1);
        });
        PrevFramePauseButton.addEventListener('click', function () {
            oneframe(-1);
        });

        // 阻止浏览器默认行为
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#f7f7f7';
            return false;
        });

        // 恢复背景颜色
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.backgroundColor = '';
        });

        // 处理拖放事件
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            //get the folder path
            const folderPath = e.dataTransfer.items[0].webkitGetAsEntry().fullPath;
            console.log(strings.selectedFolder + folderPath);
            imagepath = folderPath;
            return false;
        });
        // 获取第一个列表元素
        const list1 = document.getElementById('list1');

        // 获取第二个列表元素
        const list2 = document.getElementById('list2');

        // 定义函数以读取所选的项目
        function readSelectedItem() {
            const selectedOptionList1 = list1.options[list1.selectedIndex].text;
            const selectedOptionList2 = list2.options[list2.selectedIndex].text;
            bank = selectedOptionList1;
            anim = selectedOptionList2;
            console.log(strings.selectedBA + `${bank} 和 ${anim}`);
            clearInterval(currenttask);
            RenderAnim(animdata, true);
        }

        // 添加事件监听器以在选择发生变化时调用readSelectedItem函数
        list1.addEventListener('change', readSelectedItem);
        list2.addEventListener('change', readSelectedItem);

        function generateListItems(classes, anims) {
            let array = classes;
            let listElement = list1;
            // 清空当前列表内容
            listElement.innerHTML = '';

            // 遍历数组并创建新的列表项
            array.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                // 将新创建的列表项添加到对应的父元素中
                listElement.appendChild(option);
            });
            array = anims;
            listElement = list2;
            // 清空当前列表内容
            listElement.innerHTML = '';

            // 遍历数组并创建新的列表项
            array.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                // 将新创建的列表项添加到对应的父元素中
                listElement.appendChild(option);
            });
        }
        function OnImageRemoved(img) {
            if (trackingelement == img) {
                trackingelement = null;
            }
            if (hoverelement == img) {
                hoverelement = null;
            }
            UpdateImageInfo(hoverelement || trackingelement);
        }

        function CreateImageFromData(name, i, frame) {
            var imageInfo;
            if (typeof (name) === "string") {

                if (!build_data) return null;
                // 从 build_data 中读取图像数据
                var imageInfo = build_data[name.toLowerCase()];
                if (!imageInfo) {
                    //console.log(name, frame, "not found");
                    return null;
                }
                if (i)
                    imageInfo = imageInfo[i];
                else {
                    let _imageInfo = null;
                    for (let info of imageInfo) {
                        if (info.framenum <= frame && (info.framenum + info.duration) > frame) {
                            _imageInfo = info;
                            break;
                        }
                    }
                    imageInfo = _imageInfo;
                }
            } else {
                imageInfo = name;
                name = imageInfo.name;
            }
            if (!imageInfo) {
                //console.log(name, frame, "not found");
                return null;
            }

            // 创建图像元素
            var img = document.createElement("img");

            let x = imageInfo.x - 0;
            let y = imageInfo.y - 0;
            let w = imageInfo.w - 0;
            let h = imageInfo.h - 0;

            let px = w / 2 - x;
            let py = h / 2 - y;

            let rx = px / w;
            let ry = py / h;

            img.style.transformOrigin = px + "px " + py + "px";

            img.style.left = -px + "px";
            img.style.top = -py + "px";


            // 设置图像的src属性，格式为：name/name-frame.png
            var imageUrl = name + "/" + name + "-" + (imageInfo.frame || imageInfo.framenum || 0) + ".png";
            img.src = imagepath + imageUrl;

            // 绑定id和class属性到图像元素上
            img.setAttribute("id", name + "-" + (imageInfo.frame || imageInfo.framenum || 0));
            img.setAttribute("classname", name);
            img.setAttribute("framenum", (imageInfo.frame || imageInfo.framenum || 0));
            img.classList.add(name.replace(" ", ""));
            AllowDrag(img);
            //listen DOMNodeRemovedFromDocument
            img.addEventListener('DOMNodeRemovedFromDocument', function (event) {
                OnImageRemoved(img);
            });
            //add classname animimage
            img.classList.add("animimage");
            // 返回创建的图像元素
            return img;
        }

        // 创建一个观察器实例
        const observer = new MutationObserver((mutationsList) => {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList' && mutation.removedNodes.length > 0) {
                    Array.from(mutation.removedNodes).forEach(function (node) {
                        if (node.classList.contains("animimage")) {
                            OnImageRemoved(node);
                        }
                    });
                }
            }
        });

        // 配置观察选项
        const observer_config = { childList: true };

        // 开始观察目标节点及其子孙节点的变化
        observer.observe(imageContainer, observer_config);

        function AppendBuild(data) {
            let olddata = build_data || {};
            for (const key in data) {
                if (data.hasOwnProperty(key)) {
                    const element = data[key];
                    olddata[key] = element;
                }
            }
            build_data = olddata;
        }
        function RenderImage(data) {
            AppendBuild(data);
            data = build_data;
            // data: { image_name: { framenum: image_id } }
            // display the image having src=image_name/image_name-image_id.png
            // use document.createElement("img") to create a new image element
            // 获取包含图像的容器元素
            let container = document.getElementById("image-container");

            // 遍历 data 对象的每个键值对
            for (let imageName in data) {
                if (data.hasOwnProperty(imageName)) {
                    let imageInfo = data[imageName];
                    for (let i in imageInfo) {
                        // 创建图像元素
                        let img = CreateImageFromData(imageName, i);
                        if (img)
                            container.appendChild(img);
                    }
                }
            }
        }

        function cloneNode(node) {
            const ctn = document.getElementById("image-container-clone");
            while (ctn.firstChild) {
                ctn.removeChild(ctn.firstChild);
            }
            if (!node) return;
            // 移除克隆节点及其子节点的id属性
            const imgs = node.querySelectorAll('img');
            imgs.forEach(element => {
                if (element.style.display == 'none') return;
                const cloned = element.cloneNode(true);
                cloned.removeAttribute('id');
                cloned.classList.remove('animimage');
                cloned.classList.add('clonedanimimage');
                cloned.classList.add('no-select');
                cloned.oncontextmenu = "return false;"
                ctn.appendChild(cloned);
            });
        }

        function HideAll(parent) {
            Array.from(parent.children).forEach(child => {
                child.style.display = 'none';
            });
        }

        function RequestProgressChange() {
            let newprogress = currentframe / totalframes;
            if (!newprogress) newprogress = 0;
            progress = newprogress;
            updateProgressBar(progress);
        }
        //data:{classname:{animation_name:{framerate:30,numframes:10,frames:[frame]}}}
        //frame:{elements:[images]}
        //image:{"name": "lantern_overlay", "frame": 1, "layername": "LANTERN_OVERLAY", "m_a": 0.9428864121437073, "m_b": 0.10536190122365952, "m_c": -0.10536190122365952, "m_d": 0.9428864121437073, "m_tx": 105.44999694824219, "m_ty": -107.44999694824219, "z_index": 0},
        //render the first animation in the first class
        //use a setInterval to change the image every 1000/framerate ms
        //each time render one frame
        //each frame is defined by an array of images
        //each image is defined by its name and transform matrix, translate by (m_tx,m_ty), and z-index by z_index
        //use document.getElementById to get the image element with imageName + "-" + frame
        function RenderAnim(data, skipparse = false) {
            animdata = data;
            if (!skipparse) {
                //generate list items
                let anims = [];
                for (const classname in data) {
                    if (data.hasOwnProperty(classname)) {
                        const element = data[classname];
                        for (const animation_name in element) {
                            if (element.hasOwnProperty(animation_name)) {
                                anims.push(animation_name);
                            }
                        }
                    }
                }
                generateListItems(Object.keys(data), anims);
            }
            // Get the first animation in the first class
            let classname = bank;
            if (classname === "")
                classname = Object.keys(data)[0];
            let animation_name = anim;
            if (animation_name === "")
                animation_name = Object.keys(data[classname])[0];
            const {
                framerate,
                numframes,
                frames
            } = data[classname][animation_name];
            totalframes = numframes;
            RequestProgressChange();
            let ctn = document.getElementById('image-container');
            //clear container
            while (ctn.firstChild) {
                ctn.removeChild(ctn.firstChild);
            }
            // assign an id to every image within an animation if not exist
            for (let i = 0; i < frames.length; i++) {
                let frame = frames[i].elements;
                if (frame) {
                    let idCounter = {}; // new variable to generate unique IDs
                    for (let j = 0; j < frame.length; j++) {
                        let framedata = frame[j];
                        let id = `${framedata.name}-${framedata.frame}-`; // add unique ID to the image name
                        if (idCounter[id] === undefined)
                            idCounter[id] = 0;
                        else {
                            //console.log(idCounter[id], framedata.name, framedata.frame);
                            idCounter[id]++;
                        }
                        id = id + idCounter[id];
                        if (!document.getElementById(id)) {
                            // create new image element and set its properties

                            let newImage = CreateImageFromData(framedata.name, null, framedata.frame);
                            // append the new image element to the container
                            if (newImage) {
                                newImage.setAttribute("id", id);
                                newImage.setAttribute("layername", framedata.layername);
                                newImage.setAttribute("name", framedata.name);
                                ctn.appendChild(newImage);
                            }
                        }
                    }
                }
            }
            let currentFrame = 1;

            // Function to render each frame
            function renderFrame() {
                if (!playing && !requestframe) return;
                let requestframed = false;
                if (requestframe) {
                    currentFrame = requestframe;
                    requestframed = true;
                    requestframe = null;
                }
                if (currentFrame > numframes) {
                    currentFrame = 1;
                    //clearInterval(animationInterval);
                    //return;
                }
                if (currentFrame <= 0) {
                    currentFrame = numframes;
                    //clearInterval(animationInterval);
                    //return;
                }
                updateframe(currentFrame);
                if (!fromprogressbar)
                    RequestProgressChange();
                fromprogressbar = false;

                const frame = frames[currentFrame - 1];
                let ctn = document.getElementById('image-container');
                //clone node
                if (onionskin)
                    cloneNode(ctn);
                else
                    cloneNode();
                HideAll(ctn);
                let idCounter = {};
                // Loop through each image in the frame and update their properties
                for (const image of frame.elements) {
                    let elementId = `${image.name}-${image.frame}-`;
                    if (undefined === idCounter[elementId])
                        idCounter[elementId] = 0;
                    else idCounter[elementId]++;
                    elementId = elementId + idCounter[elementId];
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.style.transform =
                            `matrix(${image.m_a}, ${image.m_b}, ${image.m_c}, ${image.m_d}, ${image.m_tx}, ${image.m_ty})`;
                        element.style.zIndex = (50 - image.z_index).toString();
                        element.style.display = "block";
                    }
                }
                UpdateImageInfo(hoverelement || trackingelement);

                currentFrame++;
            }

            // Start rendering by calling renderFrame every interval based on framerate
            const animationInterval = setInterval(renderFrame, Math.floor(1000 / framerate));
            currenttask = animationInterval;
        }

        function handleDrop(e) {
            e.preventDefault();
            var file = e.dataTransfer.files[0];
            handleFile(file);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleFile(file) {
            if (file.type === "application/json") {
                //display the name of the file
                let name = file.name;
                document.querySelector('.drop-area').innerHTML = name;
                var reader = new FileReader();
                reader.onload = function (e) {
                    var contents = e.target.result;
                    var jsonData = JSON.parse(contents);
                    var ImageData = jsonData.Symbol;
                    var AnimData = jsonData.banks;
                    if (ImageData)
                        RenderImage(ImageData);
                    if (AnimData)
                        RenderAnim(AnimData);
                };
                reader.readAsText(file);
            } else {
                alert("请拖入有效的JSON文件！");
            }
        }

        function handleClick() {
            var fileInput = document.createElement("input");
            fileInput.type = "file";
            fileInput.accept = "application/json";
            fileInput.onchange = function (e) {
                var file = e.target.files[0];
                handleFile(file);
            };
            fileInput.click();
        }

        var dropAreas = document.getElementsByClassName("drop-area");
        for (let dropArea of dropAreas) {
            dropArea.addEventListener("drop", handleDrop, false);
            dropArea.addEventListener("dragover", handleDragOver, false);
            dropArea.addEventListener("click", handleClick, false);
        }


        //render
        function calculateCanvasParams(imgs) {

            let maxR = 0;
            let maxB = 0;
            let minL = 0;
            let minT = 0;

            imgs.forEach(img => {

                // 获取带transform后的坐标
                const { l, t, r, b } = getImageBounds(img);
                console.log(img.src, l, t, r, b);
                if (l) {

                    maxR = Math.max(maxR, r);
                    maxB = Math.max(maxB, b);

                    minL = Math.min(minL, l);
                    minT = Math.min(minT, t);
                }

            });

            // 计算canvas大小
            const canvasWidth = maxR - minL;
            const canvasHeight = maxB - minT;

            // 计算平移量
            let offsetX = minL;
            let offsetY = minT;
            return {
                width: canvasWidth,
                height: canvasHeight,
                offsetX,
                offsetY
            }

        }
        function GetMatrix(img) {
            const matrix = img.style.transform.match(/matrix\((.+?)\)/);
            if (!matrix) return [1, 0, 0, 1, 0, 0];
            let mat = matrix[1].split(',').map(n => +n);
            if (mat.length === 0) return [1, 0, 0, 1, 0, 0];
            return mat;
        }
        function getImageBounds(img) {
            const matrix = GetMatrix(img);
            if (!matrix) return {};
            const l = img.style.left.replace("px", "") - 0;
            const t = img.style.top.replace("px", "") - 0;
            const width = img.width;
            const height = img.height;
            const r = l + width;
            const b = t + height;

            const l1 = matrix[0] * l + matrix[2] * t + matrix[4];
            const t1 = matrix[1] * l + matrix[3] * t + matrix[5];
            //r1 = a * l + a * w + c * t + tx
            //b1 = b * l + d * t + d * h + ty
            const r1 = matrix[0] * l + matrix[0] * width + matrix[2] * t + matrix[4];
            const b1 = matrix[1] * l + matrix[3] * height + matrix[3] * t + matrix[5];
            return {
                l: l1,
                t: t1,
                r: r1,
                b: b1
            };
        }
        function RenderToCanvas() {
            const imgs = imageContainer.querySelectorAll('img');
            // 创建画布
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const {
                width,
                height,
                offsetX,
                offsetY
            } = calculateCanvasParams(imgs);
            // 设置画布尺寸
            canvas.width = width;
            canvas.height = height;
            ctx.translate(-offsetX, -offsetY);
            // 遍历每个img绘制
            imgs.forEach(img => {
                if (img.style.display == 'none') return;
                if (img.style.visibility == 'hidden') return;
                if (img.style.opacity == '0') return;
                // 获取transform矩阵
                const matrix = GetMatrix(img);
                if (matrix) {
                    // 保存/恢复画布状态
                    ctx.save();

                    ctx.transform(matrix[0], matrix[1], matrix[2], matrix[3], matrix[4], matrix[5]);
                    let left = img.style.left.replace("px", "");
                    let top = img.style.top.replace("px", "");
                    ctx.drawImage(img, left, top);

                    ctx.restore();
                }

            });
            ctx.translate(offsetX, offsetY);
            document.body.appendChild(canvas);
            //scroll to
            canvas.scrollIntoView();
            try {
                // 生成图片
                const image = new Image();
                image.setAttribute("crossOrigin", 'anonymous');
                image.src = canvas.toDataURL("image/png", 0.9);//format,quality
                //download
                let a = document.createElement('a');
                a.href = image.src;
                a.download = 'image.png';
                a.click();
            } catch (e) { }
        }
        const serverState = document.getElementById("paperSwitch3");
        function UpdateServerState() {
            checkServerConnection();
        }
        function checkServerConnection() {
            fetch(server_url)
                .then(response => {
                    if (response.ok) {
                        serverState.checked = true;
                    } else {
                        serverState.checked = false;
                    }
                })
                .catch(error => {
                    serverState.checked = false;
                });
        }

        checkServerConnection();
    </script>
</body>

</html>